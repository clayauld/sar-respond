services:
  caddy:
    image: caddy:alpine
    container_name: caddy-proxy
    restart: unless-stopped
    ports:
      - "8090:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
    depends_on:
      - sar-respond-azure
      - caltopo-api

  sar-respond-azure:
    build: 
      context: .
      dockerfile: Dockerfile.azure
    image: ghcr.io/clayauld/sar-respond-azure:${TAG:-latest}
    container_name: sar-respond-azure
    restart: unless-stopped
    # Ports removed to keep internal-only
    volumes:
      # Persist the database file outside the container
      - ./pb_data:/pb/pb_data
    environment:
      - TZ=America/Anchorage
    env_file:
      - .env

  caltopo-api:
    build: 
      context: ./backend_scripts
    image: ghcr.io/clayauld/sar-respond-caltopo-api:${TAG:-latest}
    container_name: sar-caltopo-api
    restart: unless-stopped
    # Ports removed to keep internal-only
    # Code is baked into the image
    env_file:
      - .env
    environment:
      - RATELIMIT_STORAGE_URI=${RATELIMIT_STORAGE_URI:-redis://redis:6379}
      - PB_INTERNAL_URL=${PB_INTERNAL_URL:-http://sar-respond-azure:8090}
    depends_on:
      - redis

  redis:
    image: redis:alpine
    container_name: sar-redis
    restart: unless-stopped
